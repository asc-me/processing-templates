{"name":"PAN-NGFW-Threat-v2","config":{"Name":"lua","match":"*","code":"cb_filter=require('calyptia.pr')([====================[[{\"type\":\"parse\",\"opts\":{\"src\":\"log\",\"dst\":\"parsed\",\"regex\":\"(?<future_use_1>[^,]*),\\\\s*(?<receive_time>[^,]*),\\\\s*(?<serial_number>[^,]*),\\\\s*(?<type>THREAT),\\\\s*(?<threat>[^,]*),\\\\s*(?<future_use_2>[^,]*),\\\\s*(?<generated_time>[^,]*),\\\\s*(?<src_address>[^,]*),\\\\s*(?<dest_address>[^,]*),\\\\s*(?<nat_source_ip>[^,]*),\\\\s*(?<nat_destination_ip>[^,]*),\\\\s*(?<rule_name>[^,]*),\\\\s*(?<src_user>[^,]*),\\\\s*(?<dest_user>[^,]*),\\\\s*(?<app>[^,]*),\\\\s*(?<virtual_system>[^,]*),\\\\s*(?<src_zone>[^,]*),\\\\s*(?<dest_zone>[^,]*),\\\\s*(?<inbound_interface>[^,]*),\\\\s*(?<outbound_interface>[^,]*),\\\\s*(?<log_action>[^,]*),\\\\s*(?<future_use_3>[^,]*),\\\\s*(?<session_id>[^,]*),\\\\s*(?<repeat_count>[^,]*),\\\\s*(?<src_port>[^,]*),\\\\s*(?<dest_port>[^,]*),\\\\s*(?<nat_source_port>[^,]*),\\\\s*(?<nat_destination_port>[^,]*),\\\\s*(?<flags>[^,]*),\\\\s*(?<ip_protocol>[^,]*),\\\\s*(?<action>[^,]*),\\\\s*(?<url>[^,]*),\\\\s*(?<threat_id>[^,]*),\\\\s*(?<category>[^,]*),\\\\s*(?<severity>[^,]*),\\\\s*(?<direction>[^,]*),\\\\s*(?<sequence_number>[^,]*),\\\\s*(?<action_flags>[^,]*),\\\\s*(?<src_location>[^,]*),\\\\s*(?<dest_location>[^,]*),\\\\s*(?<future_use_4>[^,]*),\\\\s*(?<content_type>[^,]*),\\\\s*(?<pcap_id>[^,]*),\\\\s*(?<file_digest>[^,]*),\\\\s*(?<cloud>[^,]*),\\\\s*(?<url_index>[^,]*),\\\\s*(?<user_agent>[^,]*),\\\\s*(?<file_type>[^,]*),\\\\s*(?<x_forwarded_for>[^,]*),\\\\s*(?<referer>[^,]*),\\\\s*(?<sender>[^,]*),\\\\s*(?<subject>[^,]*),\\\\s*(?<recipient>[^,]*),\\\\s*(?<report_id>[^,]*),\\\\s*(?<device_group_hierarchy_level_1>[^,]*),\\\\s*(?<device_group_hierarchy_level_2>[^,]*),\\\\s*(?<device_group_hierarchy_level_3>[^,]*),\\\\s*(?<device_group_hierarchy_level_4>[^,]*),\\\\s*(?<virtual_system_name>[^,]*),\\\\s*(?<device_name>[^,]*),\\\\s*(?<future_use_5>[^,]*),\\\\s*(?<source_vm_uuid>[^,]*),\\\\s*(?<destination_vm_uuid>[^,]*),\\\\s*(?<http_method>[^,]*),\\\\s*(?<tunnel_id>[^,]*),\\\\s*(?<monitor_tag>[^,]*),\\\\s*(?<parent_session_id>[^,]*),\\\\s*(?<parent_start_time>[^,]*),\\\\s*(?<tunnel_type>[^,]*),\\\\s*(?<threat_category>[^,]*),\\\\s*(?<content_version>[^,]*),\\\\s*(?<future_use_6>[^,]*),\\\\s*(?<sctp_association_id>[^,]*),\\\\s*(?<payload_protocol_id>[^,]*),\\\\s*(?<http_headers>[^,]*),\\\\s*(?<url_category_list>[^,]*),\\\\s*(?<rule_uuid>[^,]*),\\\\s*(?<http>[^,]*),\\\\s*(?<dynamic_user_group_name>[^,]*),\\\\s*(?<xff_address>[^,]*),\\\\s*(?<source_device_category>[^,]*),\\\\s*(?<source_device_profile>[^,]*),\\\\s*(?<source_device_model>[^,]*),\\\\s*(?<source_device_vendor>[^,]*),\\\\s*(?<source_device_os_family>[^,]*),\\\\s*(?<source_device_os_version>[^,]*),\\\\s*(?<src_hostname>[^,]*),\\\\s*(?<src_mac_address>[^,]*),\\\\s*(?<dest_device_category>[^,]*),\\\\s*(?<dest_device_profile>[^,]*),\\\\s*(?<dest_device_model>[^,]*),\\\\s*(?<dest_device_vendor>[^,]*),\\\\s*(?<dest_device_os_family>[^,]*),\\\\s*(?<dest_device_os_version>[^,]*),\\\\s*(?<dest_hostname>[^,]*),\\\\s*(?<dest_mac_address>[^,]*),\\\\s*(?<container_id>[^,]*),\\\\s*(?<pod_namespace>[^,]*),\\\\s*(?<pod_name>[^,]*),\\\\s*(?<src_external_dynamic_list>[^,]*),\\\\s*(?<dest_external_list>[^,]*),\\\\s*(?<host_id>[^,]*),\\\\s*(?<serial_number_alt>[^,]*),\\\\s*(?<domain_edl>[^,]*),\\\\s*(?<src_dynamic_address_group>[^,]*),\\\\s*(?<dest_address_group>[^,]*),\\\\s*(?<partial_hash>[^,]*),\\\\s*(?<high_resolution_timestamp>[^,]*),\\\\s*(?<reason>[^,]*),\\\\s*(?<justification>[^,]*),\\\\s*(?<a_slice_service_type>[^,]*),\\\\s*(?<app_subcategory>[^,]*),\\\\s*(?<app_category>[^,]*),\\\\s*(?<app_technology>[^,]*),\\\\s*(?<app_risk>[^,]*),\\\\s*(?<app_characteristic>[^,]*),\\\\s*(?<app_container>[^,]*),\\\\s*(?<tunneled_application>[^,]*),\\\\s*(?<app_saas>[^,]*),\\\\s*(?<app_sanctioned_state>[^,\\\\n\\\\r]*)\\\\s*\",\"regexEngine\":\"pcre2\"},\"comment\":\"PAN Threat v10\",\"id\":\"9ed6fd34-cf75-4179-9229-1f86f88aa04b\",\"active\":true},{\"type\":\"parse\",\"opts\":{\"src\":\"log\",\"dst\":\"parsed\",\"regex\":\"(?<future_use_1>[^,]*),\\\\s*(?<receive_time>[^,]*),\\\\s*(?<serial_number>[^,]*),\\\\s*(?<type>THREAT),\\\\s*(?<threat>[^,]*),\\\\s*(?<future_use_2>[^,]*),\\\\s*(?<generated_time>[^,]*),\\\\s*(?<source_address>[^,]*),\\\\s*(?<destination_address>[^,]*),\\\\s*(?<nat_source_ip>[^,]*),\\\\s*(?<nat_destination_ip>[^,]*),\\\\s*(?<rule_name>[^,]*),\\\\s*(?<source_user>[^,]*),\\\\s*(?<destination_user>[^,]*),\\\\s*(?<application>[^,]*),\\\\s*(?<virtual_system>[^,]*),\\\\s*(?<source_zone>[^,]*),\\\\s*(?<destination_zone>[^,]*),\\\\s*(?<inbound_interface>[^,]*),\\\\s*(?<outbound_interface>[^,]*),\\\\s*(?<log_action>[^,]*),\\\\s*(?<future_use_3>[^,]*),\\\\s*(?<session_id>[^,]*),\\\\s*(?<repeat_count>[^,]*),\\\\s*(?<source_port>[^,]*),\\\\s*(?<destination_port>[^,]*),\\\\s*(?<nat_source_port>[^,]*),\\\\s*(?<nat_destination_port>[^,]*),\\\\s*(?<flags>[^,]*),\\\\s*(?<ip_protocol>[^,]*),\\\\s*(?<action>[^,]*),\\\\s*(?<url>[^,]*),\\\\s*(?<threat_id>[^,]*),\\\\s*(?<category>[^,]*),\\\\s*(?<severity>[^,]*),\\\\s*(?<direction>[^,]*),\\\\s*(?<sequence_number>[^,]*),\\\\s*(?<action_flags>[^,]*),\\\\s*(?<source_location>[^,]*),\\\\s*(?<destination_location>[^,]*),\\\\s*(?<future_use_4>[^,]*),\\\\s*(?<content_type>[^,]*),\\\\s*(?<pcap_id>[^,]*),\\\\s*(?<file_digest>[^,]*),\\\\s*(?<cloud>[^,]*),\\\\s*(?<url_index>[^,]*),\\\\s*(?<user_agent>[^,]*),\\\\s*(?<file_type>[^,]*),\\\\s*(?<x_forwarded_for>[^,]*),\\\\s*(?<referer>[^,]*),\\\\s*(?<sender>[^,]*),\\\\s*(?<subject>[^,]*),\\\\s*(?<recipient>[^,]*),\\\\s*(?<report_id>[^,]*),\\\\s*(?<device_group_hierarchy_level_1>[^,]*),\\\\s*(?<device_group_hierarchy_level_2>[^,]*),\\\\s*(?<device_group_hierarchy_level_3>[^,]*),\\\\s*(?<device_group_hierarchy_level_4>[^,]*),\\\\s*(?<virtual_system_name>[^,]*),\\\\s*(?<device_name>[^,]*),\\\\s*(?<future_use_5>[^,]*),\\\\s*(?<source_vm_uuid>[^,]*),\\\\s*(?<destination_vm_uuid>[^,]*),\\\\s*(?<http_method>[^,]*),\\\\s*(?<tunnel_id>[^,]*),\\\\s*(?<monitor_tag>[^,]*),\\\\s*(?<parent_session_id>[^,]*),\\\\s*(?<parent_start_time>[^,]*),\\\\s*(?<tunnel_type>[^,]*),\\\\s*(?<threat_category>[^,]*),\\\\s*(?<content_version>[^,]*),\\\\s*(?<future_use_6>[^,]*),\\\\s*(?<sctp_association_id>[^,]*),\\\\s*(?<payload_protocol_id>[^,]*),\\\\s*(?<http_headers>[^,]*),\\\\s*(?<url_category_list>[^,]*),\\\\s*(?<rule_uuid>[^,]*),\\\\s*(?<http>[^,]*),\\\\s*(?<dynamic_user_group_name>[^,]*),\\\\s*(?<xff_address>[^,]*),\\\\s*(?<source_device_category>[^,]*),\\\\s*(?<source_device_profile>[^,]*),\\\\s*(?<source_device_model>[^,]*),\\\\s*(?<source_device_vendor>[^,]*),\\\\s*(?<source_device_os_family>[^,]*),\\\\s*(?<source_device_os_version>[^,]*),\\\\s*(?<source_hostname>[^,]*),\\\\s*(?<source_mac_address>[^,]*),\\\\s*(?<destination_device_category>[^,]*),\\\\s*(?<destination_device_profile>[^,]*),\\\\s*(?<destination_device_model>[^,]*),\\\\s*(?<destination_device_vendor>[^,]*),\\\\s*(?<destination_device_os_family>[^,]*),\\\\s*(?<destination_device_os_version>[^,]*),\\\\s*(?<destination_hostname>[^,]*),\\\\s*(?<destination_mac_address>[^,]*),\\\\s*(?<container_id>[^,]*),\\\\s*(?<pod_namespace>[^,]*),\\\\s*(?<pod_name>[^,]*),\\\\s*(?<source_external_dynamic_list>[^,]*),\\\\s*(?<destination_external_list>[^,]*),\\\\s*(?<host_id>[^,]*),\\\\s*(?<serial_number_alt>[^,]*),\\\\s*(?<domain_edl>[^,]*),\\\\s*(?<source_dynamic_address_group>[^,]*),\\\\s*(?<destination_address_group>[^,]*),\\\\s*(?<partial_hash>[^,]*),\\\\s*(?<high_resolution_timestamp>[^,]*),\\\\s*(?<reason>[^,]*),\\\\s*(?<justification>[^,]*),\\\\s*(?<a_slice_service_type>[^,]*),\\\\s*(?<application_subcategory>[^,]*),\\\\s*(?<application_category>[^,]*),\\\\s*(?<application_technology>[^,]*),\\\\s*(?<application_risk>[^,]*),\\\\s*(?<application_characteristic>[^,]*),\\\\s*(?<application_container>[^,]*),\\\\s*(?<tunneled_application>[^,]*),\\\\s*(?<application_saas>[^,]*),\\\\s*(?<application_sanctioned_state>[^,]*),\\\\s*(?<cloud_report_id>[^,]*),\\\\s*(?<cluster_name>[^,]*),\\\\s*(?<flow_type>[^,\\\\n\\\\r]*)\\\\s*\",\"regexEngine\":\"pcre2\"},\"comment\":\"PAN Threat v11\",\"id\":\"7eb30bfd-b903-4518-bcc9-539030563de5\",\"active\":false},{\"type\":\"flatten\",\"opts\":{\"key\":\"parsed\",\"regex\":\"^.+$\",\"keyReplacement\":\"%1\",\"keepOrig\":false},\"comment\":\"\",\"id\":\"75f3e442-a251-490d-80be-d3a95a82763e\",\"active\":true},{\"type\":\"custom_script\",\"opts\":{\"script\":\"return function(tag, ts, record)\\n    for k, v in pairs(record) do\\n        -- check if the value is empty\\n        if v == '' then\\n            -- delete the key\\n            record[k] = nil\\n        end\\n    end\\n    return 1, ts, record\\nend\\n\\n\\n\\n\\n\\n\\n\"},\"comment\":\"remove all keys that have empty values\",\"id\":\"fe010bc5-0459-4b7b-966e-a6696172bd76\",\"active\":true},{\"type\":\"block_keys\",\"opts\":{\"regex\":\"month|day|http|log|csv|time|future_use\",\"matchCase\":false,\"regexEngine\":\"pcre2\",\"nestedPath\":\"\"},\"comment\":\"remove original event and wrapper\",\"id\":\"daf7b885-10f8-41e9-b137-2b2c2e8d8dbb\",\"active\":true},{\"type\":\"custom_script\",\"opts\":{\"script\":\"return function(tag, ts, record)\\n    for k, v in pairs(record) do\\n        -- check if the key contains \\\"source\\\"\\n        if string.match(k, \\\"source\\\") ~= nil then\\n            -- rename the key\\n            record[k:gsub(\\\"source\\\", \\\"src\\\")] = v\\n            -- delete the old key\\n            record[k] = nil\\n        end\\n    end\\n\\n    for k, v in pairs(record) do\\n        -- check if the key contains \\\"source\\\"\\n        if string.match(k, \\\"destination\\\") ~= nil then\\n            -- rename the key\\n            record[k:gsub(\\\"destination\\\", \\\"dest\\\")] = v\\n            -- delete the old key\\n            record[k] = nil\\n        end\\n    end\\n\\n    for k, v in pairs(record) do\\n        -- check if the key contains \\\"source\\\"\\n        if string.match(k, \\\"virtual\\\") ~= nil then\\n            -- rename the key\\n            record[k:gsub(\\\"virtual\\\", \\\"vrt\\\")] = v\\n            -- delete the old key\\n            record[k] = nil\\n        end\\n    end\\n\\n    for k, v in pairs(record) do\\n        -- check if the key contains \\\"source\\\"\\n        if string.match(k, \\\"system\\\") ~= nil then\\n            -- rename the key\\n            record[k:gsub(\\\"system\\\", \\\"sys\\\")] = v\\n            -- delete the old key\\n            record[k] = nil\\n        end\\n    end\\n\\n    for k, v in pairs(record) do\\n        -- check if the key contains \\\"source\\\"\\n        if string.match(k, \\\"application\\\") ~= nil then\\n            -- rename the key\\n            record[k:gsub(\\\"application\\\", \\\"app\\\")] = v\\n            -- delete the old key\\n            record[k] = nil\\n        end\\n    end\\n    for k, v in pairs(record) do\\n        -- check if the key contains \\\"source\\\"\\n        if string.match(k, \\\"packets\\\") ~= nil then\\n            -- rename the key\\n            record[k:gsub(\\\"packets\\\", \\\"pkts\\\")] = v\\n            -- delete the old key\\n            record[k] = nil\\n        end\\n    end\\n  \\n    return 1, ts, record\\nend\"},\"comment\":\"Rename fields that contain \\\"source\\\" to \\\"src\\\"\",\"id\":\"c1f967d7-21ff-4d09-96cb-597a9fe839c0\",\"active\":true},{\"type\":\"block_keys\",\"opts\":{\"regex\":\"src_country|dst_country|action_flags|rule_uuid\",\"matchCase\":false,\"regexEngine\":\"pcre2\",\"nestedPath\":\"\"},\"comment\":\"\",\"id\":\"61a72d39-f5d4-4cb7-97f7-412bd4379eb7\",\"active\":true},{\"type\":\"custom_script\",\"opts\":{\"script\":\"return function(tag, ts, record)\\n    for k, v in pairs(record) do\\n        -- check if the value is \\\"0\\\"\\n        if v == \\\"0\\\" then\\n            -- delete the field\\n            record[k] = nil\\n        end\\n    end\\n    return 1, ts, record\\nend\"},\"comment\":\"if field value is \\\"0\\\" then remove the field\",\"id\":\"2908b07f-c20e-4853-bf2d-bfd675c45a75\",\"active\":true},{\"type\":\"custom_script\",\"opts\":{\"script\":\"return function(tag, ts, record)\\n    -- check if Tunnel_Type is equal to \\\"N/A\\\"\\n    if record['tunnel_type'] == 'N/A' then\\n        -- delete Tunnel_Type\\n        record['tunnel_type'] = nil\\n        -- delete Tunnel_ID\\n        record['tunnel_id'] = nil\\n        -- delete Tunneled_app\\n        record['tunneled_app'] = nil\\n    end\\n    return 1, ts, record\\nend\"},\"comment\":\"if Tunnel_Type has the value \\\"N/A\\\" then delete Tunnel_Type and Tunnel_ID fields\",\"id\":\"5318c192-b44f-402d-ada1-c4d52b558353\",\"active\":true},{\"type\":\"custom_script\",\"opts\":{\"script\":\"return function(tag, ts, record)\\n    -- check if app_Subcategory is equal to app_Category\\n    if record['app_subcategory'] == record['app_category'] then\\n        -- delete app_Subcategory\\n        record['app_subcategory'] = nil\\n    end\\n    return 1, ts, record\\nend\"},\"comment\":\"if app_Subcategory is equal to app_Category then delete app_Subcategory\",\"id\":\"848effb9-958b-4879-bd04-745ee0e53e00\",\"active\":true}]]====================])","call":"cb_filter"},"input":"Nov 30 16:44:36 PA-220 1,2018/11/30 16:44:36,012801096514,THREAT,url,2049,2018/11/30 16:44:36,192.168.15.224,175.16.199.1,192.168.1.63,175.16.199.1,new_outbound_from_trust,,,ssl,vsys1,trust,untrust,ethernet1/2,ethernet1/1,send_to_mac,2018/11/30 16:44:36,28191,1,52984,443,37679,443,0x403000,tcp,block-url,\"consent.cmp.oath.com/\",(9999),business-and-economy,informational,client-to-server,7726,0x2000000000000000,192.168.0.0-192.168.255.255,United States,0,,0,,,0,,,,,,,,0,0,0,0,0,,PA-220,,,,,0,,0,,N/A,unknown,AppThreat-0-0,0x0,0,4294967295,\nNov 30 16:44:36 PA-220 1,2018/11/30 16:44:36,012801096514,THREAT,url,2049,2018/11/30 16:44:36,192.168.15.224,175.16.199.1,192.168.1.63,175.16.199.1,new_outbound_from_trust,,,ssl,vsys1,trust,untrust,ethernet1/2,ethernet1/1,send_to_mac,2018/11/30 16:44:36,28219,1,52983,443,28249,443,0x403000,tcp,block-url,\"consent.cmp.oath.com/\",(9999),business-and-economy,informational,client-to-server,7727,0x2000000000000000,192.168.0.0-192.168.255.255,United States,0,,0,,,0,,,,,,,,0,0,0,0,0,,PA-220,,,,,0,,0,,N/A,unknown,AppThreat-0-0,0x0,0,4294967295,\nNov 30 16:44:36 PA-220 1,2018/11/30 16:44:36,012801096514,THREAT,url,2049,2018/11/30 16:44:36,192.168.15.224,175.16.199.1,192.168.1.63,175.16.199.1,new_outbound_from_trust,,,ssl,vsys1,trust,untrust,ethernet1/2,ethernet1/1,send_to_mac,2018/11/30 16:44:36,27723,1,52986,443,63898,443,0x403000,tcp,block-url,\"consent.cmp.oath.com/\",(9999),business-and-economy,informational,client-to-server,7728,0x2000000000000000,192.168.0.0-192.168.255.255,United States,0,,0,,,0,,,,,,,,0,0,0,0,0,,PA-220,,,,,0,,0,,N/A,unknown,AppThreat-0-0,0x0,0,4294967295,\nNov 30 16:44:36 PA-220 1,2018/11/30 16:44:36,012801096514,THREAT,url,2049,2018/11/30 16:44:36,192.168.15.224,175.16.199.1,192.168.1.63,175.16.199.1,new_outbound_from_trust,,,ssl,vsys1,trust,untrust,ethernet1/2,ethernet1/1,send_to_mac,2018/11/30 16:44:36,28172,1,52985,443,7515,443,0x403000,tcp,block-url,\"consent.cmp.oath.com/\",(9999),business-and-economy,informational,client-to-server,7729,0x2000000000000000,192.168.0.0-192.168.255.255,United States,0,,0,,,0,,,,,,,,0,0,0,0,0,,PA-220,,,,,0,,0,,N/A,unknown,AppThreat-0-0,0x0,0,4294967295,\nNov 30 16:44:36 PA-220 1,2018/11/30 16:44:36,012801096514,THREAT,url,2049,2018/11/30 16:44:36,192.168.15.224,175.16.199.1,192.168.1.63,175.16.199.1,new_outbound_from_trust,,,ssl,vsys1,trust,untrust,ethernet1/2,ethernet1/1,send_to_mac,2018/11/30 16:44:36,28151,1,52987,443,3225,443,0x403000,tcp,block-url,\"consent.cmp.oath.com/\",(9999),business-and-economy,informational,client-to-server,7730,0x2000000000000000,192.168.0.0-192.168.255.255,United States,0,,0,,,0,,,,,,,,0,0,0,0,0,,PA-220,,,,,0,,0,,N/A,unknown,AppThreat-0-0,0x0,0,4294967295,","isRawInput":true,"pipelineVersion":"24.10.0"}